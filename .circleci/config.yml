version: 2.1

jobs:
    docker:
        executor:
            name: build docker
        docker:
            - image: circleci/node:14.15.3
            - image: mongo:latest
            - image: rabbitmq:3.8.9-management-alpine
            - image: redis:6.0.9-alpine
        steps:
            - checkout
            - run: echo "docker"
    run:
        executor:
            name: run app
        steps:
            - checkout
            - run:
                  name: "What branch am I on?"
                  command: echo ${CIRCLE_BRANCH}
            - run:
                  name: npm install
                  command: sudo npm install --no-cache
            - run:
                  name: sudo npm i -g concurrently nodemon ts-node
                  command: sudo npm i -g concurrently nodemon ts-node
            - run:
                  name: sleep 30s
                  command: sleep 30
            - run:
                  name: npm run dev
                  command: sudo npm run dev
            - run:
                  name: CURL
                  command: curl http://localhost:8018/rest/v1

workflows:
    version: 2
    build-app:
        jobs:
            - docker
            - run:
                  requires:
                      - docker
                  filters:
                      branches:
                          only: develop
